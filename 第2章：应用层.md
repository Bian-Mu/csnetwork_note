
### P2P进程通信
两个不同端系统上的程序的通信，实际上是进程在通过网络交换报文。
进程通过套接字接口，使得报文可以进入运输层。套接字也成为APP和网络间的API。

进程需要知道主机地址和目的主机的对应进程标识符（目的端口号）

### 运输服务

特点：
1. 可靠数据传输
2. 吞吐量
3. 定时
4. 安全性

#### TCP
1. 面向连接，该握手连接是全双工的。
2. 字节流无丢失和冗余
3. 有拥塞控制机制，尽可能让每个连接共享带宽

#### UDP
1. 无连接
2. 可能乱序可能丢失
3. 无拥塞控制


## 应用层协议

定义了运行在不同端系统上的APP如何互相传递报文，主要包含以下内容：
1. 报文类型，请求、响应方式
2. 报文语法，字段语义
3. 进程何时、如何发送报文、如何响应

### HTTP相关（80），HTTPS（443）
#### Web与HTTP
http通过两个程序实现：客户端和服务器。二者通过http报文进行会话，
客户端通过url等方式请求http对象，服务器则做出响应。

http使用TCP作为它的支撑运输协议。

服务端发送响应后，犹豫不存储客户端状态信息，故会再二次请求时依然做出响应（http是无状态协议）

##### 连接

假设要发送1个HTML页面和10个JEPG
1. 非持续连接：针对每个文件
- 客户端发起tcp连接
- 客户端发出请求报文
- 服务器查询并响应
- 确认客户端完整受到报文后，服务器断开tcp
- 检查html，发现对10个JEPG的引用，持续上述步骤

往返时间RTT：短分组从客户端出发到达服务器后再返回的时间，包括各种时延。粗略的说，一次握手加传输html文件的时间，大概是2RTT

2. 持续连接：对所有文件
- 该连接在长时间不被使用时，由服务器关闭

#### HTTP报文格式
GET /somedir/index.html HTTP/1.1  //请求行  
Host: www.somescholl.edu  //主机  
Connection: close  //连接方式  
User-agent: Mozilla/5.0  //用户代理  
Accept-language: fr  //语言版本  
//使用POST时存在实体体  


HTTP/1.1 200 OK  //状态行  
Connection: close  //连接方式  
Date: Tue, 18 Aug 2015 15:44:04 GMT  //服务器检索并响应的时间  
Server: Apache/2.2.3 (CentOS)  //提供报文的服务器  
Last-Modified: Tue, 18 Aug 2015 15:11:03 GMT  //最后修改的时间  
Content-Length: 6821  //被发送对象的字节数  
Content-Type: text/html  //实体体中对象的类型  
...  //实体体  

常见状态码：
- 200：请求成功
- 301：对象已被永久转移，新URL在响应报文的Location行中
- 400：服务器不理解请求
- 404：被请求文档不存在
- 505：服务器不支持该请求报文的HTTP版本

##### cookie
之前提到HTTP服务器是无状态的（大致理解为不记忆对各个请求的响应状态），但有时候网站需要识别用户、限制用户等，所以开发了cookie

cookie技术在4个地方出现：
1. 响应报文
2. 请求报文
3. 用户端系统中保留cookie文件由浏览器管理
4. 服务器后端数据库

当用户首次访问时，响应报文会为发送一个唯一标识码作为cookie。浏览器会添加该cookie，在后续发送到该服务器的请求报文中都加上cookie，而服务器鉴别cookie后可以查询数据库跟踪用户历史活动记录。

##### web缓存
web缓存器也叫代理服务器，它是能够代表web初始服务器来满足http请求的网络实体。  
当浏览器设置为：http请求首先指向web缓存器 时，
1. 浏览器创建一个到web缓存器的tcp连接，并发送一个http请求
2. web缓存器进行检查，检查本地是否有请求对象的副本，有就直接响应报文
3. 如果没有，则web缓存器会打开一个与初始服务器的tcp连接，发送请求报文，并在受到响应后，先在本地存储副本，并向浏览器发送该副本

web缓存器同时是服务器和客户端，被内容分发网络CDN广泛使用

###### 缓存陈旧
存放在缓存器中的副本可能过时，需要使用条件GET方法：  
If-modified-since: ...（上次修改时间）  //条件GET的特殊首部行  

当副本不过时时，服务器会发送状态码为304 Not Modified的响应报文  

#### HTTP/2
主要目标：减小感知时延，改变数据格式化方法、客户与服务器之间的传输方式  

HTTP/1.1解决单一TCP发送web页面时部分对象延后等待（HOL，队首阻塞）的方式是打开多个TCP连接。  

HTTP/2解决方法：  
1. 成帧：报文拆成小帧，在相同TCP连接上交错发送请求和响应报文。简单理解来说，把小对象的帧一点点插在大对象的帧的队伍里。成帧子层负责拆与合
2. 响应报文的优先次序：允许研发者根据用户要求安排次序，当用户发送并发请求时，根据报文的权重（1˜256）分配小到大的响应优先权。优先级最高的响应的帧会成为第一帧
3. 服务器推：允许服务器为单一请求发送多个响应。HTML基本页指示了所需的全部对象，所以可以不必等待这些对象的请求。所以该动作是在收到相关对象明确请求前就要完成的
4. HTTP/3：QUIC基于UDP，可以实现报文交错、低延时连接等。HTTP/3基于QUIC

### FTP（20，21）

控制端口一般为21；
数据端口不一定是20，这和FTP的应用模式有关，主动模式为20，被动模式则由服务器端和客户端协商

### 电子邮件（25）

电子邮件基本组成部分：用户代理（User-Agent）、邮件服务器（Mail-Server）、简单邮件传输协议（SMTP）

A用户代理->A邮件服务器->B邮件服务器->B用户代理   
当服务器之间传输失败时，发送方会将邮件保持在报文队列中，之后会再次尝试，几天后仍不成功则发邮件通知发送方用户代理   

#### SMTP报文格式
两个邮件服务器之间依靠TCP传输数据  

From: alice@hostname.zh  
To: bob@somename.edu  
Subject: Searching for the meaning of live.  

...（报文体）  

当邮件到达接收方服务器后，接收方用户代理与服务器通过HTTP或者IMAP（因特网邮件访问协议）获得邮件  

POP3协议在端口110；IMAP协议在端口143，二者用于连接邮件传输服务器并接收邮件

### DNS（53）
是一个分层的DNS服务器实现的分布式数据库，以及一个查询用的应用层协议。DNS运行在UDP之上，DNS服务器通常是运行BIND的UNIX机器  

DNS常被其他协议调用来将主机名解析为IP地址：  
1. 浏览器作出HTTP请求，访问一个URL
2. 浏览器抽出主机名，传递给该浏览器所在主机上的DNS客户端
3. 客户端向DNS服务器发送一个包含主机名的请求
4. 客户端收到响应报文，包含对应的IP地址
5. 浏览器得到IP后，向该IP的80端口的HTTP进程请求TCP连接

除了主机名与IP解析外，DNS服务器还可以获取：主机别名、邮件服务器别名、负载分配  

#### 主机IP解析的概述

对用到DNS协议的服务来说，DNS的过程是一个黑盒  

1. 分布式、层次数据库：DNS服务器从根服务器下放到com、org、edu等顶级域TLD服务器、再到权威DNS服务器。客户先和根服务器沟通，重复返回下层服务器IP直到主机名对应的IP。同时本地DNS服务器（每个ISP都有一台本地DNS服务器），该服务器将转发客户请求到各层DNS服务器中，起着代理的作用。
	- 查询分为递归查询（自己请求）和迭代查询（其他主机请求）
2. DNS缓存：为了改善时延性能并减少DNS报文在互联网上的传播数量，增加了缓存。当某一DNS服务器接收到一个主机IP解析的DNS回答时，将其映射在本地存储器中，该缓存会在一定时间后被丢弃

#### DNS记录与报文

所有的DNS分布式数据库都存储了RR（资源记录），提供主机名与IP的映射，每个DNS报文有数条RR，是一个4元组：Name，Value，Type，TTL。TTL是该RR的生存时间  

Type的类型：  
1. A：Name为主机名，Value为对应的IP地址
2. NS：Name为域（如foo.com），Value是Name下的一个权威DNS服务器的主机名
3. CNAME：Value是主机名Name的对应的规范主机名
4. MX：Value是主机名Name对应的邮件服务器的规范主机名

如果某服务器是权威DNS服务器，则必然包含A记录，如果不是，则必然包含NS记录，同时包含NS下Value对应的DNS服务器的IP地址  

1. DNS报文：只有查询和回答两种报文，且格式一致：12字节的首部、问题、回答、权威、附加。详自己查
2. DNS数据库插入记录：注册域名（包括所用权威DNS服务器和对应IP），在权威DNS服务器中完成对A、MX的输入

## P2P文件分发

上述所讲协议都是客户端-服务器结构  

假设以下情景：单一服务器向大量主机分发一个大文件。在原体系中服务器必须向每个对等方（连接的对象）发送一个该文件的副本。而在P2P中，每个对等方可以向任何其他对等方重新分发它收到的部分，从而帮助服务器减负。  

1. 扩展性：考虑服务器会将文件F发给固定的对等方集合，再分发出去。假设有N个对等方，Us为服务器上载速率、Dmin为对等方最小下载速率，则TimeTotal＝max{F/Us, F/Dmin, NF/(Us+UNtotal)}
2. BitTorrent：一种P2P协议。参与文件分发的对等方集合称为洪流。当某一对等方A进入洪流时，向追踪器注册自己，并周期性通信。追踪器确认对等方，并允许对等方拥有一张洪流子集表L，可以对其中的IP创建TCP连接分发文件，此时二者成为邻近对等方。在给定的洪流子集中，每个对等方具有文件块的不同子集。A会向L中每个对等方索取文件块列表，对还没有的块发出请求：最稀缺优先原则，优先获取集合中副本最少的文件块。A会获取每个请求的速率，来确定A要响应的邻居集合，此时两个对等方疏通。邻居集合会不断迭代

##  视频流与内容分发网
#### HTTP流和DASH
流式视频程序周期性的从下载到缓存中的文件中抓帧解压呈现  

上述方式编码固定，不能适应带宽。  
DASH（基于HTTP的动态适应性流）将视频编码成不同比特率的版本，客户端根据带宽，实时发送不同视频版本的请求（这些版本的URL存在HTTP服务器中的告示文件中）  

#### 内容分发网CDN
可以是第三方的，也可以是专用的，CDN管理分布在多个地理位置的服务器，在其中存储文件的副本  

##### CDN操作
部署完成之后，CDN会尝试截获（DNS）用户主机浏览器的相关文件检索，作出如下动作：  
1. 确定合适的CDN服务器集群
2. 将客户请求重定向（DNS）到具体服务器

集群选择策略：地理邻近、性能实时测量等  

## 套接字编程
根据开发协议标准是否公开，分为开放网络应用程序和专用网络应用程序（同时影响了程序端口号的选择）  

写法见互联网
#### UDP套接字
#### TCP套接字