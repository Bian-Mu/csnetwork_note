网络层分为两个相互作用的平面：数据平面、控制平面

数据平面功能即网络层中每台路由器的功能，决定了到达路由器输入链路之一的数据报如何转发到路由器的输出链路之一

控制平面功能即网络范围的逻辑，控制着数据报沿着源主机到目的主机的端到端路劲中，路由器之间的路由方式

### 网络层概述

路由器是不运行高层协议的

#### 转发和路由选择

![[Screenshot_2024-12-20-13-57-40-089_com.flyersoft.moonreaderp.png]]
##### 转发
当一个分组到达某路由器的一条输入链路时，路由器要将该分组移动到适合的输出链路，转发是数据平面的唯一功能，路由器也可以阻挡源、目的有问题的分组。

属于路由器本地操作，尺度很短（通常为纳秒），依靠硬件实现。

每台路由器中都有关键元素：转发表。路由器检查分组首部的一些字段，依靠这些字段值在转发表中查询。

##### 路由选择
当分组从发送方流向接收方时，网络层必须决定分组采用的路由/路径。决定方式取决于路由选择算法

属于网络范围处理过程，尺度较大（通常为秒），依靠软件实现

路由选择算法：决定了插入路由器的转发表中的内容，路由器之间通过该算法通信，计算出转发表中的值（见上图）

SDN（软件定义网络）：也是用于确定转发表内容的。远程控制器来计算和分发转发表以供路由器使用，SDN通常交给第三方管理，此时路由器不接入算法，只进行转发（见下图）
![[Screenshot_2024-12-20-14-04-35-443_md.obsidian.png]]

#### 网络服务模型
定义了分组在发送和接收主机之间的端到端传输特性。

网络层通常提供以下服务：
- 确保交付：分组会到达目的地
- 具有时延上界的确保交付：分组会到达目的地，并且会在规定时间内交付
- 有序分组交付：分组会按照发送顺序到达目的地
- 确保最小带宽：模仿发送方和接收方之间一条特定比特率X bps的传输链路的行为。只要发送方不超过X，则分组会到达目的地
- 安全性：在源加密所有数据报、在目的解密

通常情况下，因特网的网络层服务（只提供发送分组的尽力而为服务，什么都不保证）+适当带宽供给+带宽自适应应用级协议的结合，可以满足大量应用所需

链路层交换机：基于链路层帧的字段的值做出决定
路由器：基于网络层数据报首部字段值做出转发决定，这是本章所讲的

### 路由器工作原理（转发）

![[2d2994bbca28338a90fa3a02f4eade43.png]]
对于上述每个端口（此处端口是物理接口）中的方框，具有以下功能：
1. 最外侧（小）：物理链路的物理层功能
2. 居中：数据链路层功能
3. 内侧（线路卡）：查找/存储

转发功能实现结构，全双工连接的输入输出端口一般在同一线路卡上：
- 输入端口：终结物理层、交互链路层数据、查询转发表并发送分组
- 交换结构：将输入输出端口相连接
- 输出端口：存储分组、交互链路层数据、启用物理层
- 路由选择处理器：网络管理。传统下，执行路由选择协议、维护路由选择表和关联链路状态、计算转发表；SDN下，与远程控制器通信、接收转发表、在输入端口安装转发表

上述功能结构大多通过硬件实现，因为软件处理转发的速度赶不上：IP数据报大小/链路速率（纳秒级别）

转发时需要处理的信息：
1. 基于目的地转发：在入口时有明确的出口
2. 泛化转发：通过其他信息推测可能的出口

转发时可能需要解决的问题：入口处拥堵、链路拥堵、出口拥堵与优先权等

#### 输入端口的处理（基于目的地转发）

最主要的功能是查询转发表，这张表是从路由选择处理器通过独立总线复制到线路卡的（见虚线），因此每个线路卡都会存有副本，无需集中式处理

在32比特IP地址的情况下，转发表无法存下所有地址，因此会分为多个区间。此时可以将链路接口与IP的前缀位匹配，存在即可向该接口转发（区间前缀重合时，采用最长前缀匹配，例如1100和11000取后者）

获得转发表后，为了提高查询速度，需要使用硬件查找并且考虑算法和内存访问时间。实践中经常使用TCAM（三态内容可寻址存储器）

查询确定输出端口后，该分组进入队列，排队使用交换结构。除了查找，输入端口还得：
1. 处理物理层和链路层
2. 检查分组的版本号、校验和（并重写）、寿命字段（并重写）
3. 更新网络管理的计数器

总的来说，输入端口的一系列动作其实可以被抽象成“匹配+操作”，这在之后的一些协议实现中也有体现

#### 交换

实现交换的三种方式：
![[Screenshot_2024-12-23-14-30-05-877_md.obsidian.png]]
1. 经过内存交换：将输入输出接口视为I/O设备。分组中断后发送信号，然后处理器将其复制到自己的内存中，在首部提取目的地址，通过转发表将分组复制到输出端口的缓存中。现在的路由器，查找和存储都使用输入线路卡处理。总线每次只能执行一次内存读/写
2. 经过总线交换：输入端口经一根共享总线将分组直接传送到输出端口，不经过处理器。输入分组可以被所有输出端口接收，但只有目的端口可以保存。总线每次只允许一个分组跨越
3. 经过互联网络交换：使用更加复杂的互联网络克服总线的共享、带宽限制。纵横式交换机的输入、交换是非阻塞的

#### 输出端口处理

选择并取出分组、传输分组（链路层、物理层）

#### 排队出现的原因

假设链路传输速率为Rline，有N个输入端口和N个输出端口，分组长度固定，同步到达输入端口。从输入端口到输出端口速率记作Rswitch。

如果Rswitch＝N X Rline，则几乎不会出现排队

1. 输入排队：