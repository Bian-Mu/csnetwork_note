网络层分为两个相互作用的平面：数据平面、控制平面

数据平面功能即网络层中每台路由器的功能，决定了到达路由器输入链路之一的数据报如何转发到路由器的输出链路之一

控制平面功能即网络范围的逻辑，控制着数据报沿着源主机到目的主机的端到端路劲中，路由器之间的路由方式

### 网络层概述

路由器是不运行高层协议的

#### 转发和路由选择

![[Screenshot_2024-12-20-13-57-40-089_com.flyersoft.moonreaderp.png]]
##### 转发
当一个分组到达某路由器的一条输入链路时，路由器要将该分组移动到适合的输出链路，转发是数据平面的唯一功能，路由器也可以阻挡源、目的有问题的分组。

属于路由器本地操作，尺度很短（通常为纳秒），依靠硬件实现。

每台路由器中都有关键元素：转发表。路由器检查分组首部的一些字段，依靠这些字段值在转发表中查询。

##### 路由选择
当分组从发送方流向接收方时，网络层必须决定分组采用的路由/路径。决定方式取决于路由选择算法

属于网络范围处理过程，尺度较大（通常为秒），依靠软件实现

路由选择算法：决定了插入路由器的转发表中的内容，路由器之间通过该算法通信，计算出转发表中的值（见上图）

SDN（软件定义网络）：也是用于确定转发表内容的。远程控制器来计算和分发转发表以供路由器使用，SDN通常交给第三方管理，此时路由器不接入算法，只进行转发（见下图）
![[Screenshot_2024-12-20-14-04-35-443_md.obsidian.png]]

#### 网络服务模型
定义了分组在发送和接收主机之间的端到端传输特性。

网络层通常提供以下服务：
- 确保交付：分组会到达目的地
- 具有时延上界的确保交付：分组会到达目的地，并且会在规定时间内交付
- 有序分组交付：分组会按照发送顺序到达目的地
- 确保最小带宽：模仿发送方和接收方之间一条特定比特率X bps的传输链路的行为。只要发送方不超过X，则分组会到达目的地
- 安全性：在源加密所有数据报、在目的解密

通常情况下，因特网的网络层服务（只提供发送分组的尽力而为服务，什么都不保证）+适当带宽供给+带宽自适应应用级协议的结合，可以满足大量应用所需

链路层交换机：基于链路层帧的字段的值做出决定
路由器：基于网络层数据报首部字段值做出转发决定，这是本章所讲的

### 路由器工作原理（转发）

![[2d2994bbca28338a90fa3a02f4eade43.png]]
对于上述每个端口（此处端口是物理接口）中的方框，具有以下功能：
1. 最外侧（小）：物理链路的物理层功能
2. 居中：数据链路层功能
3. 内侧（线路卡）：查找/存储

转发功能实现结构，全双工连接的输入输出端口一般在同一线路卡上：
- 输入端口：终结物理层、交互链路层数据、查询转发表并发送分组
- 交换结构：将输入输出端口相连接
- 输出端口：存储分组、交互链路层数据、启用物理层
- 路由选择处理器：网络管理。传统下，执行路由选择协议、维护路由选择表和关联链路状态、计算转发表；SDN下，与远程控制器通信、接收转发表、在输入端口安装转发表

上述功能结构大多通过硬件实现，因为软件处理转发的速度赶不上：IP数据报大小/链路速率（纳秒级别）

转发时需要处理的信息：
1. 基于目的地转发：在入口时有明确的出口
2. 泛化转发：通过其他信息推测可能的出口

转发时可能需要解决的问题：入口处拥堵、链路拥堵、出口拥堵与优先权等

#### 输入端口的处理（基于目的地转发）

最主要的功能是查询转发表，这张表是从路由选择处理器通过独立总线复制到线路卡的（见虚线），因此每个线路卡都会存有副本，无需集中式处理

在32比特IP地址的情况下，转发表无法存下所有地址，因此会分为多个区间。此时可以将链路接口与IP的前缀位匹配，存在即可向该接口转发（区间前缀重合时，采用最长前缀匹配，例如1100和11000取后者）

获得转发表后，为了提高查询速度，需要使用硬件查找并且考虑算法和内存访问时间。实践中经常使用TCAM（三态内容可寻址存储器）

查询确定输出端口后，该分组进入队列，排队使用交换结构。除了查找，输入端口还得：
1. 处理物理层和链路层
2. 检查分组的版本号、校验和（并重写）、寿命字段（并重写）
3. 更新网络管理的计数器

总的来说，输入端口的一系列动作其实可以被抽象成“匹配+操作”，这在之后的一些协议实现中也有体现

#### 交换

实现交换的三种方式：
![[Screenshot_2024-12-23-14-30-05-877_md.obsidian.png]]
1. 经过内存交换：将输入输出接口视为I/O设备。分组中断后发送信号，然后处理器将其复制到自己的内存中，在首部提取目的地址，通过转发表将分组复制到输出端口的缓存中。现在的路由器，查找和存储都使用输入线路卡处理。总线每次只能执行一次内存读/写
2. 经过总线交换：输入端口经一根共享总线将分组直接传送到输出端口，不经过处理器。输入分组可以被所有输出端口接收，但只有目的端口可以保存。总线每次只允许一个分组跨越
3. 经过互联网络交换：使用更加复杂的互联网络克服总线的共享、带宽限制。纵横式交换机的输入、交换是非阻塞的

#### 输出端口处理

选择并取出分组、传输分组（链路层、物理层）

#### 排队出现的原因

假设链路传输速率为Rline，有N个输入端口和N个输出端口，分组长度固定，同步到达输入端口。从输入端口到输出端口速率记作Rswitch。

如果Rswitch＝N X Rline，则几乎不会出现排队

1. 输入排队（<）：假使输入端口1、2分别有分组AB、CD，其中AC都发往输出端口3。那么如果A先进入交换结构，那么CD都需要排队，无论D是否发生竞争（HOL竞争）
2. 输出排队：假设=，如果有N个分组要进入同一个输出端口，则进入后N-1个分组都要等待该端口的链路进行传输。当缓存不够时，一般会做出弃尾（丢弃新分组）操作，同时向发送方提供一个拥塞信号（可以使用明确拥塞通告ECN来标记分组）。当前最广泛的AQM（主动队列管理算法）是RED（随机早期检测）

##### 确定缓存大小

一般来说，缓存大小B=RTT x 链路容量C。
当有大量TCP流经过链路时，B'=B/(N^1/2)，而在核心网络中，大量流经过大型主干路由器链路，N会很大。

不能一味增大缓存，会导致更长的排队时延。在网络边缘，并没有很多独立发送方竞争带宽和缓冲区。
![[bed1c6b69e235e06cffd5e26b2e01b10.png]]
缓存膨胀（持续缓冲而导致长时延）：假设t=0时突然传来25个分组，每10ms传输一次分组，RTT=200ms。那么当t=200ms时，第一个ACK到达，此时TCP发送方会发送一个新的分组，该分组最终进入链路排队，而10ms后另一个ACK到达（期间输出端口保持发送）。以此类推，最终队列长度会维持在5个分组。后续到达的分组始终需要等到50ms才能被发送。

针对缓存膨胀，增加了一种特殊的AQM机制（位于链路层）

#### 分组调度
排队的分组以怎样的次序经输出链路传输？


1. 先进先出（FIFO）：![[042411f51c48ae560f3faf4129799be2.png]]![[a0433a241634f653e6112a1a62745943.png]]
2. 优先队列：在非抢占式优先权排队中，分组已经传输则不能被打断![[6d9c3a6ef7cecbb885ed23d324bbd13c.png]]![[8e5dbf76cb3a442001fb64eab223cf64 1.png]]
3. 循环排队：分类但循环的为每类提供传输，始终保持工作，发现空集时立刻移动到下一个类![[695d64c5337573cfec1abc54e83bc7eb.png]]
4. 加权公平排队（WFQ）：属于循环排队的一种，但是每个类i都会被分配权重wi，在i有分组要发送时，其分配到的速率至少是R x wi/sum(w)![[8ad9a3930128028bd642586dbc34c739.png]]


### 网际协议

#### IPv4数据报格式

![[844c2f945706152d70db4cb593b46986.png]]
- 版本号4bit：规定了数据报的IP协议版本
- 首部长度4bit：IPv4数据报有一些可变数量的选项，故用首部来确定实际载荷（例如报文段）开始的地方。无选项首部一般为20字节
- 服务类型（TOS）8bit：包含在首部里，可以与IP数据报作区分。可以用于提供特定等级的服务
- 数据报长度16bit：这是首部+数据的长度，单位为字节
- 标识、标识、片偏移：涉及到数据报在路由器中被分片转发，以及到达目的地之后的组装
- 寿命TTL8bit：确保数据报不会一直在网络中循环。被路由器处理时减1，为0时必须被丢弃
- 上层协议8bit：通常当IP数据报到达最终目的地时被使用。指明了数据部分应该交给那个特定的运输层协议（例如6给TCP、17给UDP）。通过协议号，网络层与运输层可以绑定到一起（类似于端口号对于运输层和应用层）
- 首部检验和16bit：帮助路由器检测数据报中的比特错误，计算方式见互联网。路由器进行检验，一般会丢弃有错误的数据报。每台路由器上都要重新计算检验和并放到远处（TTL和选项字段可能变化）
- 源目IP地址：在源生成数据报时，会在IP地址字段插入对应的IP地址。通常源主机通过DNS确定目的主机的IP地址
- 选项：该字段允许IP首部被扩展。此时会让数据字段的开始地址被改变。选项字段在IPv6中被去除
- 数据：包含要交付给目的地的运输层报文段，也可能承载其他类型的数据比如ICMP报文

注意到报文段中也有首部。常规情况下总共存在40字节的首部


#### IPv4编址

IP要求每台主机和路由器的接口有自己的IP地址。（技术上，IP应该是和接口绑定的）

32位的IP地址通过点分十进制记法书写

![[6b0fd5eb634e5ff860e69b95f77e7a48.png]]
空白处为交换机/无线网，每个空白外接的所有接口形成一个子网。

以左上为例，子网会被分配到地址223.1.1.0/24，24是子网掩码（指示了左侧24比特定义了子网地址）。该子网中有3个主机接口和1个路由器接口。任何要接入该子网的主机，都应该有233.1.1.xxx格式的地址。

以下网络具有6个子网：
![[14b4f2345397269b579f12c87f942bc5.png]]

因特网的地址分配策略称为“无类别域间路由选择”CIDR。CIDR将IP地址划分为网络部分（前缀）和组织内部分。也可以用a.b.c.d/x表示。
- 组织内部设备将共享高x比特的前缀。（此时如果路由器要将数据报转发到组织内，则转发表的长度大大减小）
- 低32-x比特的地址用于区分组织内部设备，如上所言只有在内部转发时才考虑这些比特。要明确的是，剩下的这些低位比特也可以用于组织第二层子网
- IP广播地址255.255.255.255是一个特殊的目的地址，该目的报文会被交付到源主机所属网络下的所有主机。路由器也有小概率可能发往相邻子网

##### 获取地址

1. 组织为设备得到一块地址：网络管理员向ISP请求一块地址，ISP的地址块来自ICANN组织（他们同时也负责DNS根服务器的管理、域名分配与纷争）
2. 主机与路由器的接口获得一个地址：路由器接口的IP一般是管理员手动配置；主机的IP可以人为手动分配，但更多通过DHCP（动态主机配置协议）。某主机接入网络时，会被分配一个临时的IP地址。DHCP还会允许接入主机得知其他信息（包括但不限于子网掩码、第一跳路由地址/默认网关、本地DNS服务器的地址）

DHCP常称为即插即用协议、零配置协议。

DHCP是一个客户－服务器协议。最简单的情况下，每个子网都有一台DHCP服务器，否则需要通过路由器进行DHCP中继代理，该代理需要知晓所需DHCP服务器的地址。客户到达时，新主机将通过DHCP获得网络配置信息。DHCP对于新客户的交涉过程如下：
![[Screenshot_2024-12-24-14-17-19-217_com.flyersoft.moonreaderp.png]]
- yiaddr：分配给新客户的IP地址，该过程经过以下4个步骤：
1. DHCPDISCOVER：新到达的主机首先应该得到一台可以交互的DHCP服务器。客户通过UDP向端口67发送“DHCP发现报文”（目的地址为广播地址），此时源地址为0.0.0.0。在该IP数据报到达链路层后，链路层将该帧广播到所有与子网连接的节点
2. DHCPOFFER：当一个服务器收到一个“DHCP发现报文”之后，将用“DHCP提供报文”作出响应，这一报文依然被广播（同一子网内可能存在多个DHCP，广播后供客户选择）。每台服务器的报文中都包含“发现报文”的事物ID、推荐给客户的IP地址、网络掩码、IP地址租用期
3. DHCPREQUEST：客户从数个服务器中选择其一，并向该DHCP服务器响应“DHCP请求报文”，回显配置的参数
4. DHCPACK：服务器用“DHCPACK报文”，证实所要求的参数

完成以上4个步骤后，交互完成了，客户可以在IP租用期内使用分配到的IP地址。如果客户在超时后仍然想要续租，则有额外的机制。

DHCP在移动性方面有很严重的缺陷，例如移动节点在子网间移动时不能维持与远程应用的TCP连接。该问题通过移动网络来解决

####  网络地址转换NAT
![[Screenshot_2024-12-24-18-39-19-542_com.flyersoft.moonreaderp.png]]

NAT允许专用网络使用只对子网内部的设备有意义的地址。

本质上说，NAT对内对外都隐藏了细节

假设从WAN到达NAT路由器的所有数据报都具有相同的IP地址，路由器可以查询NAT转换表，其中存有“WAN端IP+端口”与“LAN端IP+端口”的一一映射。反之同理。由于端口号字段为16bit，故可以存储超过6万个表项。LAN端出现新的使用端口时，NAT中可以任意选择一个未使用的端口作为WAN端出口。每次转换时，NAT会重写数据报中的源目IP和端口

NAT的转换操作对内对外都是不可见的。

事实上，端口应该用于进程寻址，而非主机寻址，这可能会引发问题。为了解决可能的周知端口占用、P2P对等方服务器连接等问题，提出了NAT穿越工具和UPnP（通用即插即用协议）。UPnP允许主机发现和配置邻近的NAT

#### IPv6

##### IPv6数据报格式
![[Screenshot_2024-12-24-19-14-33-564_md.obsidian.png]]
IPv6相比IPv4，最主要的变化如下：
- 扩大的地址容量：从32bit增大到128bit。除了单播和多播外，引入了任播地址，该地址可以使得数据报可以被交付给一组主机中的任意一个
- 简化高效的首部：舍弃可选项，首部固定为40字节
- 流标签：IPv6有一个定义模糊的流，该字段用于给流添加标签。

IPv6数据报组成如下：
- 版本4bit
- 流量类型8bit：与TOS类似
- 流标签20bit
- 有效载荷长度16bit：给出跟在首部后的字节数量
- 下一个首部8bit：等同于上层协议字段
- 跳限制8bit：类似于TTL
- 源目地址
- 数据

相比于IPv4，去除了数据报分片与重组、首部检验和、选项（可能出现在下一个首部所指位置）

##### 版本迁移

在实践中广泛使用的迁移方法有建隧道：
![[Screenshot_2024-12-24-19-42-36-187_md.obsidian.png]]
直接把B的要传给E的数据报整个塞到IPv4的数据字段里


###  泛化转发和SDN

之前讲过基于目的地的转发表，泛化转发将这一行为抽象成“匹配并操作表”，由于抽象后的转发决策可能是网络层（路由器），也可能是链路层（交换机），故本节改称“分组交换机”。

“匹配”直接对协议栈的多个首部字段进行匹配；
“操作”直接将分组转发到数个输出端口并可以为接口实现负载均衡，同时重写首部值，有意识的丢弃/保留一个分组，为进一步处理和操作而向特定服务器发送分组

![[5cc2128e1d5f6b436c5c643985e086af.png]]
上图模拟了泛化转发，分组交换机中的表由远程控制器计算、安装、更新。
OpenFlow 1.0标准将SDN引入了泛化转发，以下讨论基于该标准。
匹配加操作转发表以后称为流表，它具有以下表项：
1. 首部字段值的集合：入分组将尝试和该表项匹配。实践中一个流表可能有多个流表组成
2. 计数器集合：当入分组与表项匹配时，计数器更新。计数器可以包括该表项被成功匹配的次数，该表项最近的更新时间
3. 操作集合：入分组成功和表项匹配时，会采取的一系列操作。可能包括转发、丢弃、复制、重写首部

#### 匹配
![[52c01e3d56bf66d95af9b3ef6db1ab22.png]]
OpenFlow直接打破了分层原则，允许直接匹配多层次的协议首部。

- 入端口：指的是分组交换机上的输入端口
- 通配符：流表项也可以有类似前缀匹配的方式：128.129.X.X，可以匹配任何128.129开头的数据报的IP地址。如果一个分组匹配多个流表项，也有相应的优先级规则

#### 操作
在一系列的有序操作中，最重要的可能是：
1. 转发：一个入分组可以被转发到特定的物理输出端口，广播到所有端口，或者通过所选项进行多播。该分组可能被封装发送给远程控制器。
2. 丢弃：没有操作的流表项表明该项匹配的分组需要被丢弃
3. 修改字段：部分首部字段可以被重写

#### 实例（见书本）

### 中间盒

在源目主机之间所有IP路由器之外的提供其他功能的盒子
大致有以下三类：
1. NAT转换
2. 安全服务：防火墙基于首部字段或者重定向分组来阻塞流量从而进行附加处理，尤其是DPI（深度分组检测）；IDS（入侵检测系统）能够检测预先确定的模式，并相应的过滤分组
3. 性能增强：诸如压缩、内容缓存、负载均衡等服务

随着功能和设备的变化，逐渐出现了用软件堆栈等方式来处理这些服务，称为NFV（网络功能虚拟化）